---
date: 2026-02-01
category: Mobile
title: 웹 플랫폼 401 Unauthorized 오류 수정
author: Claude Opus 4.5
tags: [bugfix, web, authentication, platform-factory, critical]
priority: high
---

# 웹 플랫폼 401 Unauthorized 오류 수정

## 개요
웹 앱(`lemon.3chan.kr/app/`)에서 로그인 후 모든 인증 필요 API 호출이 401 Unauthorized 오류를 반환하는 문제를 수정했습니다.

## 문제 / 배경

### 증상
- `GET /api/progress/user/2` → 401
- `GET /api/progress/stats/2` → 401
- `GET /api/content/vocabulary/bookmarks` → 401

### 근본 원인
`AuthProvider`와 `AuthRepository`가 플랫폼 팩토리 패턴을 우회하고 `FlutterSecureStorage`를 직접 사용:

```dart
// ❌ 웹에서 동작하지 않음 - FlutterSecureStorage는 모바일 전용
final FlutterSecureStorage _secureStorage = const FlutterSecureStorage();
```

### 실패 과정
1. 사용자가 로그인 성공, 토큰 수신
2. `AuthProvider.login()`이 `FlutterSecureStorage.write()`로 토큰 저장 시도
3. 웹에서: `FlutterSecureStorage`가 조용히 실패 (모바일 전용 설계)
4. 토큰이 **저장되지 않음**
5. `ApiClient`의 `_AuthInterceptor`가 null 토큰 읽음
6. `Authorization` 헤더가 요청에 추가되지 않음
7. 모든 보호된 엔드포인트가 401 반환

### 역설적 상황
웹 플랫폼 구현 자체는 올바름:
- `SecureStorageWeb`이 `localStorage` 올바르게 사용 ✅
- `PlatformFactory`가 웹 구현 올바르게 생성 ✅
- `ApiClient`가 `PlatformFactory.createSecureStorage()` 올바르게 사용 ✅
- 하지만 `AuthProvider`와 `AuthRepository`가 **팩토리를 완전히 우회** ❌

## 해결책 / 구현

`FlutterSecureStorage` 직접 사용을 `PlatformFactory.createSecureStorage()`로 교체.

### 변경 사항 1: auth_provider.dart

```dart
// ❌ Before
import 'package:flutter_secure_storage/flutter_secure_storage.dart';
// ...
final FlutterSecureStorage _secureStorage = const FlutterSecureStorage();

// ✅ After
import '../../core/platform/platform_factory.dart';
import '../../core/platform/secure_storage_interface.dart';
// ...
final ISecureStorage _secureStorage = PlatformFactory.createSecureStorage();
```

### 변경 사항 2: auth_repository.dart

```dart
// ❌ Before
import 'package:flutter_secure_storage/flutter_secure_storage.dart';
// ...
final FlutterSecureStorage _secureStorage = const FlutterSecureStorage();

// ✅ After
import '../../core/platform/platform_factory.dart';
import '../../core/platform/secure_storage_interface.dart';
// ...
final ISecureStorage _secureStorage = PlatformFactory.createSecureStorage();
```

### 추가 수정: 타입 안전성
`ISecureStorage.write()`는 non-nullable `String`을 요구하지만, `AuthResult`의 토큰들은 nullable. null 체크 후에도 Dart 타입 프로모션이 필드에서 작동하지 않아 명시적 `!` 연산자 추가:

```dart
// ❌ Before - 컴파일 오류
if (result.token != null) {
  await _secureStorage.write(key: AppConstants.tokenKey, value: result.token);
}

// ✅ After - non-null 명시적 어서션
if (result.token != null) {
  await _secureStorage.write(key: AppConstants.tokenKey, value: result.token!);
}
```

## 변경된 파일
- `/mobile/lemon_korean/lib/presentation/providers/auth_provider.dart` - PlatformFactory 사용
- `/mobile/lemon_korean/lib/data/repositories/auth_repository.dart` - PlatformFactory 사용

## 테스트

### 빌드 검증
```bash
cd mobile/lemon_korean
flutter build web
# ✓ Built build/web (286초)
```

### 배포
```bash
docker compose restart nginx
# Container lemon-nginx Started
```

### 기능 테스트
1. https://lemon.3chan.kr/app/ 접속
2. 유효한 자격 증명으로 로그인
3. DevTools → Application → Local Storage에서 `auth_token` 키 확인
4. Console에서 401 오류 없음 확인
5. 홈 화면에서 통계 정상 로드 확인

## 관련 이슈 / 참고사항

### 문제 발생 이유
- `ApiClient`는 초기에 올바르게 `PlatformFactory` 패턴으로 구현됨
- `AuthProvider`와 `AuthRepository`는 나중에 추가되었고, 기존 모바일 코드 패턴을 따름
- 웹 플랫폼 지원 추가 시 이 파일들을 누락

### 학습 포인트
- 새 파일 추가 시 플랫폼 팩토리 패턴 일관성 확인 필요
- 웹 빌드 후 인증 흐름 전체 테스트 필요
- `FlutterSecureStorage`는 모바일에서는 조용히 동작하지만 웹에서는 실패

### 영향 받는 기능
- 로그인
- 회원가입
- 토큰 갱신
- 자동 로그인
- 모든 인증 필요 API 호출

---

# 추가 수정: JWT_SECRET 불일치 (2026-02-01 오후)

## 개요
웹 앱에서 여전히 401 오류가 발생하여 추가 조사 결과, Progress Service와 Media Service에 `JWT_SECRET` 환경변수가 설정되지 않은 것을 발견했습니다.

## 문제 / 배경

### 근본 원인
| 서비스 | JWT_SECRET 설정 | 사용되는 값 |
|--------|----------------|-------------|
| auth-service | `${JWT_SECRET}` | `.env`의 실제 시크릿 |
| content-service | `${JWT_SECRET}` | `.env`의 실제 시크릿 |
| progress-service | **미설정** | Go 코드 기본값 `default_secret_change_in_production` |
| media-service | **미설정** | Go 코드 기본값 `default_secret_change_in_production` |

Auth Service에서 발급한 JWT 토큰이 Progress/Media Service에서 다른 시크릿으로 검증되어 항상 실패했습니다.

## 해결책 / 구현

`docker-compose.yml`에서 Progress Service와 Media Service에 `JWT_SECRET` 환경변수 추가:

```yaml
# Progress Service
progress-service:
  environment:
    # ... 기존 변수들 ...
    JWT_SECRET: ${JWT_SECRET}  # 추가됨

# Media Service
media-service:
  environment:
    # ... 기존 변수들 ...
    JWT_SECRET: ${JWT_SECRET}  # 추가됨
```

## 변경된 파일
- `/home/sanchan/lemonkorean/docker-compose.yml` - JWT_SECRET 환경변수 추가

## 테스트

### 서비스 재시작
```bash
docker compose up -d progress-service media-service
docker compose restart nginx
```

### JWT_SECRET 확인
```bash
docker exec lemon-progress-service printenv JWT_SECRET
# 출력: Scott... (Auth Service와 동일)

docker exec lemon-media-service printenv JWT_SECRET
# 출력: Scott... (Auth Service와 동일)
```

### API 테스트
```bash
# 토큰 없이 호출 (401 예상)
curl -s "https://lemon.3chan.kr/api/progress/user/42"
# 결과: {"error":"Unauthorized","message":"Authorization header required"} - 정상

# 토큰과 함께 호출 (401이 아닌 응답 예상)
curl -s -H "Authorization: Bearer $TOKEN" "https://lemon.3chan.kr/api/progress/user/42"
# 결과: 500 (인증 통과, DB 스키마 문제로 인한 별도 오류)
```

## 검증 결과
- [x] Progress Service에 JWT_SECRET 설정됨
- [x] Media Service에 JWT_SECRET 설정됨
- [x] 토큰 없이 호출 시 401 반환 (정상)
- [x] 토큰과 함께 호출 시 401이 아닌 다른 응답 (인증 통과)

## 발견된 추가 문제 (별도 수정 필요)

Progress Service에서 500 Internal Server Error 발생:
```
pq: column "time_spent_minutes" does not exist
```
이는 데이터베이스 스키마와 Go 코드 간의 불일치 문제로, JWT 인증과는 무관합니다.
