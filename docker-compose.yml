# version: '3.8'  # Deprecated - removed to avoid warnings

services:
  # ==================== Infrastructure Services ====================

  # PostgreSQL Database
  # ⚠️ DO NOT modify 'command' or config settings here
  # ⚠️ Edit config/postgres/postgresql.conf instead
  # ⚠️ Apply changes: docker compose restart postgres
  postgres:
    image: postgres:15-alpine
    container_name: lemon-postgres
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-lemon_korean}
      POSTGRES_USER: ${POSTGRES_USER:-3chan}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./database/postgres/init:/docker-entrypoint-initdb.d
      - ./config/postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
    ports:
      - "5432:5432"
    networks:
      - lemon-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-3chan}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # MongoDB Database
  # ⚠️ DO NOT modify 'command' or config settings here
  # ⚠️ Edit config/mongo/mongod.conf instead
  # ⚠️ Apply changes: docker compose restart mongo
  # ⚠️ Data stored on local disk: ./data/mongo-data
  # ⚠️ Running as uid 1000 to match local directory ownership
  mongo:
    image: mongo:4.4
    container_name: lemon-mongo
    user: "1000:1000"
    command: mongod --config /etc/mongod.conf
    environment:
      MONGO_INITDB_ROOT_USERNAME: 3chan
      MONGO_INITDB_ROOT_PASSWORD: ${DB_PASSWORD}
      MONGO_INITDB_DATABASE: ${POSTGRES_DB:-lemon_korean}
    volumes:
      - ./data/mongo-data:/data/db
      - mongo-log:/var/log/mongodb
      - ./database/mongo/init:/docker-entrypoint-initdb.d
      - ./config/mongo/mongod.conf:/etc/mongod.conf:ro
    ports:
      - "27017:27017"
    networks:
      - lemon-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongo localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Redis Cache
  # ⚠️ DO NOT modify 'command' or config settings here
  # ⚠️ Edit config/redis/redis.conf instead
  # ⚠️ Apply changes: docker compose restart redis
  redis:
    image: redis:7-alpine
    container_name: lemon-redis
    command: redis-server /etc/redis/redis.conf --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis-data:/data
      - ./config/redis/redis.conf:/etc/redis/redis.conf:ro
    ports:
      - "6379:6379"
    networks:
      - lemon-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # MinIO (S3-compatible storage)
  # ⚠️ Data stored on local disk: ./data/minio-data
  minio:
    image: minio/minio:latest
    container_name: lemon-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY}
    volumes:
      - ./data/minio-data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    networks:
      - lemon-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    restart: unless-stopped

  # RabbitMQ Message Queue
  # ⚠️ DO NOT modify config settings here
  # ⚠️ Edit config/rabbitmq/rabbitmq.conf instead
  # ⚠️ For queue definitions: config/rabbitmq/definitions.json
  # ⚠️ Apply changes: docker compose restart rabbitmq
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: lemon-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: 3chan
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
      - ./config/rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ./config/rabbitmq/definitions.json:/etc/rabbitmq/definitions.json:ro
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - lemon-network
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # ==================== Management Tools ====================

  # pgAdmin - PostgreSQL Management UI
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: lemon-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: 3chan@lemon.com
      PGADMIN_DEFAULT_PASSWORD: Scott122001&&
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    ports:
      - "5050:80"
    networks:
      - lemon-network
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  # Mongo Express - MongoDB Management UI
  mongo-express:
    image: mongo-express:latest
    container_name: lemon-mongo-express
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: 3chan
      ME_CONFIG_MONGODB_ADMINPASSWORD: ${DB_PASSWORD}
      ME_CONFIG_MONGODB_URL: mongodb://3chan:${DB_PASSWORD}@mongo:27017/
      ME_CONFIG_BASICAUTH_USERNAME: 3chan
      ME_CONFIG_BASICAUTH_PASSWORD: Scott122001&&
    ports:
      - "8081:8081"
    networks:
      - lemon-network
    depends_on:
      mongo:
        condition: service_healthy
    restart: unless-stopped

  # Redis Commander - Redis Management UI
  redis-commander:
    image: ghcr.io/joeferner/redis-commander:latest
    container_name: lemon-redis-commander
    environment:
      REDIS_HOSTS: local:redis:6379:0:${REDIS_PASSWORD}
      HTTP_USER: 3chan
      HTTP_PASSWORD: Scott122001&&
      PORT: 8082
    ports:
      - "8082:8082"
    networks:
      - lemon-network
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  # ==================== Microservices ====================

  # Auth Service (Node.js) - JWT 인증
  auth-service:
    build:
      context: ./services/auth
      dockerfile: Dockerfile
    container_name: lemon-auth-service
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3001
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
      DATABASE_URL: postgres://${POSTGRES_USER:-3chan}:${DB_PASSWORD}@postgres:5432/${POSTGRES_DB:-lemon_korean}
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
    ports:
      - "3001:3001"
    volumes:
      - ./services/auth/src:/app/src
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - lemon-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Content Service (Node.js) - 레슨/단어/문법 데이터
  content-service:
    build:
      context: ./services/content
      dockerfile: Dockerfile
    container_name: lemon-content-service
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3002
      JWT_SECRET: ${JWT_SECRET}
      DATABASE_URL: postgres://${POSTGRES_USER:-3chan}:${DB_PASSWORD}@postgres:5432/${POSTGRES_DB:-lemon_korean}
      MONGO_URL: mongodb://3chan:${DB_PASSWORD}@mongo:27017/${POSTGRES_DB:-lemon_korean}?authSource=admin
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
    ports:
      - "3002:3002"
    volumes:
      - ./services/content/src:/app/src
    depends_on:
      postgres:
        condition: service_healthy
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - lemon-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Progress Service (Go) - 학습 진도, SRS 알고리즘
  progress-service:
    build:
      context: ./services/progress
      dockerfile: Dockerfile
    container_name: lemon-progress-service
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3003
      JWT_SECRET: ${JWT_SECRET}
      DATABASE_URL: postgres://${POSTGRES_USER:-3chan}:${DB_PASSWORD}@postgres:5432/${POSTGRES_DB:-lemon_korean}?sslmode=disable
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      RABBITMQ_URL: amqp://3chan:${RABBITMQ_PASSWORD}@rabbitmq:5672/
    ports:
      - "3003:3003"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - lemon-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Media Service (Go) - 이미지/오디오 서빙, MinIO
  media-service:
    build:
      context: ./services/media
      dockerfile: Dockerfile
    container_name: lemon-media-service
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3004
      JWT_SECRET: ${JWT_SECRET}
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_BUCKET: lemon-korean-media
      MINIO_USE_SSL: "false"
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    ports:
      - "3004:3004"
    depends_on:
      minio:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - lemon-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Analytics Service (Python) - 로그 분석
  analytics-service:
    build:
      context: ./services/analytics
      dockerfile: Dockerfile
    container_name: lemon-analytics-service
    environment:
      ANALYTICS_SERVICE_PORT: 3005
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${POSTGRES_DB:-lemon_korean}
      DB_USER: ${POSTGRES_USER:-3chan}
      DB_PASSWORD: ${DB_PASSWORD}
      MONGODB_URI: mongodb://3chan:${DB_PASSWORD}@mongo:27017/${POSTGRES_DB:-lemon_korean}?authSource=admin
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      LOG_LEVEL: INFO
    ports:
      - "3005:3005"
    volumes:
      - ./services/analytics:/app
    depends_on:
      postgres:
        condition: service_healthy
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - lemon-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:3005/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Admin Service (Node.js) - 관리자 대시보드
  admin-service:
    build:
      context: ./services/admin
      dockerfile: Dockerfile
    container_name: lemon-admin-service
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3006
      DATABASE_URL: postgres://${POSTGRES_USER:-3chan}:${DB_PASSWORD}@postgres:5432/${POSTGRES_DB:-lemon_korean}
      MONGO_URL: mongodb://3chan:${DB_PASSWORD}@mongo:27017/${POSTGRES_DB:-lemon_korean}?authSource=admin
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_USE_SSL: "false"
      JWT_SECRET: ${JWT_SECRET}
      ADMIN_EMAILS: admin@lemon.com
    # Port not exposed - only accessible through nginx proxy at /admin/
    volumes:
      - ./services/admin/src:/app/src
      - ./services/admin/public:/app/public
      - ./.env:/app/.env
      - /var/run/docker.sock:/var/run/docker.sock
      - ./:/project:ro  # Project root for docs (read-only)
      - ./data/apk-builds:/apk-builds:ro  # APK storage (read-only)
    depends_on:
      postgres:
        condition: service_healthy
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - lemon-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3006/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==================== API Gateway & Proxy ====================

  # Nginx API Gateway
  # ⚠️ Logs & cache stored on local disk: ./data/nginx-*
  # ⚠️ Running as uid 1000 to match local directory ownership
  nginx:
    build: ./nginx
    container_name: lemon-nginx
    user: "1000:1000"
    environment:
      NGINX_MODE: ${NGINX_MODE:-development}
    volumes:
      - ./data/nginx-cache:/var/cache/nginx
      - ./data/nginx-logs:/var/log/nginx
      # Direct config mount (changes take effect with reload)
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      # Logrotate config
      - ./nginx/logrotate.conf:/etc/logrotate.d/nginx:ro
      # SSL certificates (for development)
      - ./nginx/ssl:/etc/nginx/ssl:ro
      # Flutter web app build output (local disk)
      - ./data/flutter-build/web:/var/www/lemon_korean_web:ro
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      auth-service:
        condition: service_healthy
      content-service:
        condition: service_healthy
      progress-service:
        condition: service_healthy
      media-service:
        condition: service_healthy
      # analytics-service:
      #   condition: service_healthy
      # admin-service:
      #   condition: service_healthy
    networks:
      - lemon-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Nginx Proxy Manager
  nginx-proxy-manager:
    image: jc21/nginx-proxy-manager:latest
    container_name: lemon-nginx-proxy-manager
    ports:
      - "81:81"      # Admin Web UI
      - "8090:80"    # HTTP Proxy
      - "4443:443"   # HTTPS Proxy
    environment:
      DB_SQLITE_FILE: /data/database.sqlite
      DISABLE_IPV6: true
    volumes:
      - nginx-proxy-manager-data:/data
      - nginx-proxy-manager-letsencrypt:/etc/letsencrypt
    networks:
      - lemon-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/bin/check-health"]
      interval: 30s
      timeout: 3s
      retries: 3

# ==================== Networks ====================
networks:
  lemon-network:
    driver: bridge
    name: lemon-network

# ==================== Volumes ====================
# Note: All data moved to local ./data/ directory
volumes:
  postgres-data:
    name: lemon-postgres-data
  mongo-log:
    name: lemon-mongo-log
  redis-data:
    name: lemon-redis-data
  rabbitmq-data:
    name: lemon-rabbitmq-data
  pgadmin-data:
    name: lemon-pgadmin-data
  nginx-proxy-manager-data:
    name: lemon-nginx-proxy-manager-data
  nginx-proxy-manager-letsencrypt:
    name: lemon-nginx-proxy-manager-letsencrypt
