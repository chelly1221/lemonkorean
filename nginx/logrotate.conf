# Nginx Log Rotation Configuration for Lemon Korean
#
# This configuration rotates nginx access and error logs to prevent unbounded growth.
#
# Installation:
#   sudo cp /home/sanchan/lemonkorean/nginx/logrotate.conf /etc/logrotate.d/lemon-nginx
#   sudo chmod 644 /etc/logrotate.d/lemon-nginx
#
# Test:
#   sudo logrotate -d /etc/logrotate.d/lemon-nginx
#
# Manual run:
#   sudo logrotate -f /etc/logrotate.d/lemon-nginx

/home/sanchan/lemonkorean/nginx/logs/*.log {
    # Rotate logs daily
    daily

    # Keep 14 days of logs (2 weeks)
    rotate 14

    # Compress old logs (after 1 day delay)
    compress
    delaycompress

    # Don't rotate if log file is empty
    notifempty

    # Don't error if log file is missing
    missingok

    # Create new log file with these permissions
    create 0640 sanchan sanchan

    # Date extension format (YYYYMMDD)
    dateext
    dateformat -%Y%m%d

    # Run postrotate script only once (not once per log file)
    sharedscripts

    # Reload nginx after rotation
    postrotate
        # Send reload signal to nginx container
        docker exec lemon-nginx nginx -s reload 2>/dev/null || true

        # Alternative: Use kill -USR1 (traditional nginx reload)
        # NGINX_PID=$(docker exec lemon-nginx cat /var/run/nginx.pid 2>/dev/null)
        # [ -n "$NGINX_PID" ] && docker exec lemon-nginx kill -USR1 $NGINX_PID 2>/dev/null || true
    endscript
}

# Specific configuration for error logs (more aggressive retention)
/home/sanchan/lemonkorean/nginx/logs/error.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    missingok
    create 0640 sanchan sanchan
    dateext
    dateformat -%Y%m%d
    sharedscripts
    postrotate
        docker exec lemon-nginx nginx -s reload 2>/dev/null || true
    endscript
}
